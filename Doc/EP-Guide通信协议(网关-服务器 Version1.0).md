网关—Server通信协议（Version 1.3）
================
##### 修改记录：
	version 1.0  时间 2016-1-4 新增
    version 1.01 时间 待定

##### 一、协议简介
	网关和服务器之间采用Socket进行通信（Socket是对TCP/IP协议的封装和应用）
	网关-服务端TCP监听端口：5080
	服务器-客户端通信监听端口：5090

##### 二、	报文结构介绍
注:整个通信的报文采用16进制格式

| 传输层 |||| 业务层 |||
|--------|--------|
| 消息头 | 消息ID | 网关Mac地址 | 消息体长度 | 命令字 | 消息体 | 校验字 |
| gMsgHead | gMsgID | gGtwMac | gMsgLen | bMsgCmd | bMsgBody | bMsgVrf |
| 2Byte | 2Byte | 6Byte | 2Byte | 2Byte | nByte | 1Byte |
**其中需要注意的如下：**

* 消息头固定为：**0xA402**

* 消息ID无符号两字节，递增，网关控制

* 登录时在MAC地址后加 <kbd>A-402</kbd> 字串，然后对其合并后用MD5进行加密

* 高字节在前（先发高字节，再发低字节）

* 消息长度为消息体长度
* 校验字使用和校验 前面所有字节之和对256取余

##### 三、 命令集

| 命令分类 | 命令描述 | 命令字 | 命令编码 | 传输方向 |
|--------|--------|
| 基本请求 | 登录、心跳包等 |
|    1.1    |网关登录服务器请求      | cReqGateWayLogin | 0x0101 | 网关-Server |
|    1.2    | 服务器响应网关登录     | cAckGateWayLogin | 0x0801 | Server-网关 |
|    1.3    | 链路请求(消息体空)     | cReqLinkCheck | 0x0102 | 网关-Server |
|    1.4    | 链路请求响应(消息体空) | cAckLinkCheck | 0x0802 | Server-网关 |
| 节点操作 | 管理员操作时更改 |
|    2.1    | 节点添加请求 | cReqAddNode | 0x0104 | 网关-Server |
|    2.2    | 节点添加响应 | cAckAddNode | 0x0804 | Server-网关 |
|    2.3    | 节点删除请求 | cReqNodeDel | 0x0105 | 网关-Server |
|    2.4    | 节点删除响应 | cAckNodeDel | 0x0805 | Server-网关 |
| 控制 | 客户端预约车位时控制 |
|    3.1    | 更改车位状态请求 | cReqNodeStatusUpdate | 0x0107 | 网关-Server |
|    3.2    | 更改车位状态响应 | cAckNodeStatusUpdate | 0x0807 | Server-网关 |
| 同步 | 车位状态改变时同步 |
|    4.1    | 节点信息同步通知 | cReqNotNodeInforSync | 0x0108 | 网关-Server |
|    4.2    | 节点信息同步通知响应 | cAckNotNodeInforSync | 0x0808 | Server-网关 |
| 触发模式 | 车辆入库时触发 |
|    5.1    | 最短路线配置请求 | cReqShortLoad | 0x0103 | 网关-Server |
|    5.2    | 最短路线配置响应 | cAckShortLoad | 0x0803 | Server-网关 |

##### 四、 消息体定义

**==1.1 登录请求：==**
 - 说明：通过网关Mac地址+A-402 合并后用MD5进行加密
 - 消息体：
   |内容|
   |--------|
   |MD5加密字串（16字节）|

**==1.2 登录响应：==**
 - 说明：1=成功 , 0=失败
 - 消息体：
   |内容|
   |--------|
   |是否成功（2字节）|

**==1.3 链路请求：==**
 - 说明：心跳请求：网关-服务器，间隔30s
 - 消息体：
   |内容|
   |--------|
   |null|

**==1.4 链路请求响应：==**
 - 说明：1=成功 , 0=失败
 - 消息体
   |内容|
   |--------|
   |是否成功（2字节）|

**==2.1 节点添加请求：==**
 - 说明：添加节点信息，下面检测到新的节点时，向服务器发送添加新的节点请求
 - 消息体：
   |内容	  |
   |--------|
   |节点个数（2）|
   |           |节点MAC地址（6） |

**==2.2 节点添加响应：==**
 - 说明：添加结果-->1=成功 , 0=失败 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 车位状态-->0：空闲  1：占用
 - 消息体：
   |内容|
   |--------|
   |是否成功（2）|
   |该节点的初始状态（2）|

**==2.3 节点删除请求：==**
 - 说明：删除某一车位节点
 - 消息体：
   |内容	  |
   |--------|
   |节点个数（2）|           |
   |           |节点MAC地址 |


**==2.4 节点删除响应：==**
 - 说明：是否删除成功-->1：成功 0：失败
 - 消息体：
   |内容|
   |--------|
   |是否成功（2）|



**==3.1 更改车位状态请求：==**
 - 说明：车挺进车位后需更改状态信息
 - 消息体：
   |内容	  |
   |--------|
   |节点MAC（6）|
   |节点状态（2）|
   |车主ID（4）|


**==3.2 更改车位状态响应：==**
 - 说明：是否更改成功-->1：成功 0：失败
 - 消息体：
   |内容|
   |--------|
   |是否成功（2）|

**==4.1 节点信息同步通知：==**
 - 说明：网关请求服务是否有车位被预约
 - 消息体：
   |内容	  |
   |--------|
   |空闲节点个数（2）|
   |  节点MAC（6）  |

**==4.2 节点信息同步通知响应：==**
 - 说明：返回已被预约的车位节点ID，返回消息体为null说明没有被预约的
 - 消息体：
   |内容|
   |--------|
   |已预约车位节点个数（2） |
   |节点MAC（6） |

**==5.1 最短路线配置请求：==**
 - 说明：在得知车库有空闲后再发，将所有车位节点的数据同步到服务器，服务器解析并寻找最短路径
 - 消息体：
   |内容	  |
   |--------|
   |节点个数（2）|           |
   |           |节点MAC（6） |
   |           |节点状态（2）|


**==5.2 最短路线配置请求：==**
 - 说明：返回车主需走过的最短车位节点ID队列，最后一个即为要进的车位，如果为null则表示没空闲车位
 - 消息体：
   |内容	  |
   |--------|
   |节点个数（2）|           |
   |           |节点MAC（6） |


