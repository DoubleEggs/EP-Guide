EP-Guide嵌入式固件说明（V1.0）
=======

# 车库主控
* WIFI为AP+Station模式，作为车库其它节点的AP，同时联网，与服务器交互
  * AP名称：EP-Guide    (WIFI.cpp中可以修改)
  * AP密码：1208077207  (WIFI.cpp中可以修改)
  * AP IP：192.168.4.1                  (WIFI.cpp中可以修改)
  * AP端口：345
  * AP 网关：192.168.4.1  与主控的IP要相同 (WIFI.cpp中可以修改)

  * 作为Station连接的AP名：ICanHearYou
  * 密码：1208077207
  * MAC：12:08:07:72:07:01
* 由于WIFI耗用时间久，RFID扫描（轮询）又对时间要求高，所以要在程序上保证RFID能正确执行
* 对车位节点进行轮询来实现检测车位信息

# 车位节点

* 被动接收主控的轮询
* 既是客户端，也开启TCP服务器，监听来自主控的轮询


# 主控与节点之间的通信

#### 节点-->主控
* 已知主控IP和端口，即可发送数据
* 数据帧格式

#### 主控-->节点
* 由于主控不知道具体哪个IP对应哪个车位，因此需要将IP与节点编号绑定
  * 主控上电1分钟（等待所有的节点连接进来）后，查询已经连接进来了的节点IP，然后分别向它们请求获取对应的车库节点编号
  * 每隔半分钟进行检测，连接进来的节点数量和IP是否发生变化，如果变化了，重新向各个节点查询IP对应的编号
  * 在检测的时候不能一次性等待检测所有的节点，可能会导致长时间等待，导致无法识别进来的车辆，因此获得一个节点编号后在下一个轮回再读取下一个节点编号

#### 协议
**一）、消息帧定义**

| 传输层 |||| 业务层 |||
|--------|--------|
| 消息头 | 消息ID | 节点Mac地址 | 消息体长度 | 命令字 | 消息体 | 校验字 |
| gMsgHead | gMsgID | gGtwMac | gMsgLen | bMsgCmd | bMsgBody | bMsgVrf |
| 2Byte | 2Byte | 6Byte | 2Byte | 2Byte | nByte | 1Byte |

**二）、命令字定义**

| 命令编号 | 命令描述 | 命令字 | 命令编码 | 传输方向 |
|--------|--------|
|    1    | 主控向节点请求状态信息   | cReqStatus | 0x0201 | 主控-节点 |
|    2    | 节点响应主控状态信息请求 | cAckStatus | 0x0902 | 节点-主控 |

##### 1 状态信息同步到主控
**1.1 主控向节点请求状态消息**
* 消息体
| 内容 |
|--------|
|  null  |

**1.2节点响应状态请求**
* 消息体
| 内容 |
|------|
| 状态信息（1字节） |
* 状态信息定义
| 状态字           | 含义  | 命令编码 |
|--------|--------|                |
| NodeStatus_Busy | 有车  | 0x20    |
| NodeStatus_Free | 空闲  | 0x10    |
| NodeStatus_Disable | 不使用该车位  | 0x08    |
| NodeStatus_ToBusy | 从空闲到有车  | 0x04    |
| NodeStatus_ToFree | 从有车到空闲  | 0x02    |


# 主控-->服务器

* 协议见网关与服务器之间通信的协议文档

