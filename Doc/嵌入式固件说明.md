EP-Guide嵌入式固件说明（V1.3）
=======
# 使用步骤及工作流程说明
1. 车库主控、车位节点、服务安装、部署
2. 开启服务器
3. 管理员现在管理系统（服务器端）进行设置节点数量以及添加MAC地址
4. 主控开机，上电两个灯闪烁一下，然后进行系统初始化、连接wifi等操作，直到交替闪烁表示初始化完毕。<br/>然后双闪表示登录服务器成功，闪4下表示登录服务器失败（如果在后面掉线了也是如此）
5. 车位节点开机
6. 主控对所有连接进来了的节点进行轮询，向服务器请求添加节点，添加成功（根据管理员是否将MAC地址加入白名单）后将IP地址与MAC地址进行绑定；如果已经存在了的节点的IP地址有变化，重新设置绑定的IP值
7. 主控定时进行轮询，发现车位状态更改便向服务器报送
8. 当门禁（暂时由主控担任）检测到有车来临时，向服务器请求车位和到达该车位的路径（由车位组成），然后通知节点进行引导（灯光提示），当车在车位（不一定是系统指定的，可以由用户喜好自己选）停下后，主控在轮询中检测到，向服务器报告车位状态的改变，并向节点发送完成引导的消息，然后节点完成引导（灯光恢复正常，绿灯亮表示空闲，红灯亮表示已被占用或者已经被预约）
9. 当汽车离去时，车位检测到状态改变，在主控轮询的时候发送消息给主控，然后主控将消息传递给服务器

# 车库主控
* WIFI为AP+Station模式，作为车库其它节点的AP，同时联网，与服务器交互
  * AP名称：EP-Guide    (WIFI.cpp中可以修改)
  * AP密码：1208077207  (WIFI.cpp中可以修改)
  * AP IP：192.168.4.1                  (WIFI.cpp中可以修改)
  * AP端口：345
  * AP 网关：192.168.4.1  与主控的IP要相同 (WIFI.cpp中可以修改)

  * 作为Station连接的AP名：ICanHearYou
  * 密码：1208077207
  * MAC：12:08:07:72:07:01
* 由于WIFI耗用时间久，RFID扫描（轮询）又对时间要求高，所以要在程序上保证RFID能正确执行
* 对车位节点进行轮询来实现检测车位信息

# 车位节点

* 被动接收主控的轮询
* 既是客户端，也开启TCP服务器，监听来自主控的轮询
* 使用端口号：345 （即节点建立端口号为345的TCP服务）


# 主控与节点之间的通信

#### 节点-->主控
* 节点被动，响应主控的请求

#### 主控-->节点
* 由于主控不知道具体哪个IP对应哪个车位，因此需要将IP与节点MAC绑定
  * 在主控向节点请求状态信息时，在节点返回MAC地址+状态数据后，将IP与MAC进行绑定
* 主控定时向节点请求状态信息


#### 协议
**一）、消息帧定义**

| 传输层 |||| 业务层 |||
|--------|--------|
| 消息头 | 消息ID | 节点Mac地址 | 消息体长度 | 命令字 | 消息体 | 校验字 |
| gMsgHead | gMsgID | gGtwMac | gMsgLen | bMsgCmd | bMsgBody | bMsgVrf |
| 2Byte | 2Byte | 6Byte | 2Byte | 2Byte | nByte | 1Byte |

**二）、命令字定义**

| 命令编号 | 命令描述 | 命令字 | 命令编码 | 传输方向 |
|--------|--------|
|    1    | 主控向节点请求状态信息   | cReqStatus | 0x0201 | 主控-节点 |
|    2    | 节点响应主控状态信息请求 | cAckStatus | 0x0901 | 节点-主控 |
|    3    | 主控向节点请求道路引导   | cReqLead | 0x0202 | 主控-节点 |
|    4    | 节点响应主控道路引导请求 | cAckLead | 0x0902 | 节点-主控 |
|    5    | 主控向节点请求完成道路引导   | cReqCompleteLead | 0x0203 | 主控-节点 |
|    6    | 节点响应主控完成道路引导请求 | cAckCompletLead | 0x0903 | 节点-主控 |

##### 1 状态信息同步到主控
**1.1 主控向节点请求状态消息**
* 消息体
| 内容 |
|--------|
|  null  |

**1.2节点响应状态请求**
* 消息体
| 内容 |
|------|
| 状态信息（1字节） |
| 车辆ID号（4字节） |
* 状态信息定义
| 状态字           | 含义  | 命令编码 |
|--------|--------|                |
| NodeStatus_Busy | 有车  | 0x20    |
| NodeStatus_Free | 空闲  | 0x10    |
| NodeStatus_Disable | 不使用该车位  | 0x08    |
| NodeStatus_ToBusy | 从空闲到有车  | 0x04    |
| NodeStatus_ToFree | 从有车到空闲  | 0x02    |

##### 2 引导道路
**2.1 主控向节点发送引导道路消息**
* 消息体
| 内容 |
|--------|
| 引导角色（1字节）  |
* 角色
| 角色         | 命令编码  |
|-------------|----------|
|  引导        |  0x22    |
|停车车位（终点）| 0x11     |

**2.2 节点对主控引导道路消息的响应**
* 消息体
| 内容 |
|--------|
|  成功？（1字节）  |
* 返回数据定义
| 状态 | 消息编码 |
|--------|--------|
|   成功     |   1     |
|   失败     |   0     |

**2.3 主控向节点发送完成引导道路消息**
* 消息体
| 内容 |
|--------|
| null  |

**2.4 节点对主控完成引导道路消息的响应**
* 消息体
| 内容 |
|--------|
|  成功？（1字节）  |
* 返回数据定义
| 状态 | 消息编码 |
|--------|--------|
|   成功     |   1     |
|   失败     |   0     |

# 主控-->服务器

* 协议见网关与服务器之间通信的协议文档

